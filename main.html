<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
    <title>Sunrise lights</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        /* font-family: 'Brush Script MT', serif; */
        /* font-family: ui-monospace; */
        font-family: 'Gill Sans', 'Gill Sans MT', sans-serif;
        font-size: 1.1rem;
        color: white;
      }
      button, input {
        color: black;
      }
      input[type=range] {
        width: 180px;
      }
      html, body {
        overflow-x: hidden;
      }
      body {
        position: relative;
        padding: 15px;
        background-color: black;
      }
      #main {
        margin: auto;
        max-width: 750px;
      }
      #tabs {
        display: flex;
        justify-content: space-between;
      }
      .tab-link {
        padding: 10px 0;
        flex-grow: 1;
        text-decoration: underline;
        text-align: center;
        font-size: 1rem;
      }
      .tab-link-selected {
        background-color: #444444;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
      .tab-content {
        display: none;
        background-color: #444444;
        padding: 15px;
        min-height: 150px;

        flex-direction: column;
        align-items: center;
      }
      .content-spacing {
        margin: 20px 0;
      }
      .hue-input {
        margin: 6px 0; 
        padding: 8px 10px;
        border: 2px solid black;
        border-radius: 5px;
      }
      .buttons {
        margin-top: 12px;
        width: 6rem;
      }
    </style>
  </head>

  <body>
    <div id='main'>
      <b>Lights</b>
      <br/>
      <br/>
      <div id='tabs'>
        <a class='tab-link' onclick='showTab(0)'>Rave</a>
        <a class='tab-link' onclick='showTab(1)'>Swirl</a>
        <!-- <a class='tab-link' onclick='showTab()'>Siren</a> -->
        <a class='tab-link' onclick='showTab(2)'>Solid</a>
        <a class='tab-link' onclick='showTab(3)'>Sunrise</a>
      </div>


      <!-- Rave -->
      <div class='tab-content'>
        <span class='content-spacing'>
          <input type='radio' id='rave-value-flash' name='rave-values' value='flash' checked/>
          <label for='rave-value-flash'>Flash</label>
          <br/>
          <input type='radio' id='rave-value-rainbow' name='rave-values' value='rainbow'/>
          <label for='rave-value-rainbow'>Rainbow</label>
        </span>
        <span class='content-spacing'>
          <label style='margin-top: 10px' for='rave-speed'>Speed: </label>
          <br/>
          <input id='rave-speed' type='range' min='1' max='255' step='1' value='200'/>
        </span>
        <span class='content-spacing'>
          <label for='rave-brightness'>Brightness: </label>
          <br/>
          <input id='rave-brightness' type='range' min='1' max='255' step='1' value='128'/>
        </span>
      </div>

      <!-- Swirl -->
      <div class='tab-content'>
        <span class='content-spacing hue-input' id='swirl-hue-1-parent' style='background-color: rgb(255,38,0);'>
          <input id='swirl-hue-1' type='range' min='0' max='330' step='1' value='10'/> <!-- max value here must match value in hueInputToByte() -->
        </span>
        <span class='content-spacing hue-input' id='swirl-hue-2-parent' style='background-color: rgb(0,255,132);'>
          <input id='swirl-hue-2' type='range' min='0' max='330' step='1' value='150'/>
        </span>
        <span class='content-spacing hue-input' id='swirl-hue-3-parent' style='background-color: rgb(47,0,255);'>
          <input id='swirl-hue-3' type='range' min='0' max='330' step='1' value='250'/>
        </span>

        <span class='content-spacing'>
          <label for='swirl-speed'>Speed: </label>
          <br/>
          <input id='swirl-speed' type='range' min='1' max='255' step='1' value='20'/>
        </span>
        <span class='content-spacing'>
          <label for='swirl-brightness'>Brightness: </label>
          <br/>
          <input id='swirl-brightness' type='range' min='1' max='255' step='1' value='128'/>
        </span>

        <!-- <span class='content-spacing'>
          <i>Preset #1</i>
        </span> -->
      </div>

      <!-- Solid -->
      <div class='tab-content'>
        <input class='content-spacing' id='solid-color' type='color' value='#ff00ff'/>
      </div>

      <!-- Sunrise -->
      <div class='tab-content' style='align-items: start;'> 
        <span class='content-spacing'>
          <label for='sunrise-time'>By time</label>
          <input id='sunrise-time' type='time' value='09:00'/>
        </span>

        <span class='content-spacing'>
          <label for='sunrise-color'>get to color</label>
          <input id='sunrise-color' type='color' value='#ff00ff'/>
        </span>

        <span class='content-spacing'>
          <label for='sunrise-brightness'>get to brightness</label>
          <input id='sunrise-brightness' type='number' size='5' value='255' min='0' max='255'/>
        </span>

        <span class='content-spacing'>
          <label for='sunrise-duration'>over</label>
          <input id='sunrise-duration' type='number' size='5' value='30' min='0' max='1439'/>
          minutes
        </span>
      </div>

      <!-- Buttons -->
      <div style='text-align: center;'>
        <button id='submit' class='buttons' onclick='submit()'>Submit</button>
        <br/>
        <button id='off' class='buttons' onclick='postData([0])'>Off</button>
      </div>

    </div>


    <script type='text/javascript'>
      let contents = [];
      let links = [];
      let selectedIndex;

      function inputToRGB(e) {
        const v = document.getElementById(e).value;
        return [parseInt(v.substr(1,2), 16), parseInt(v.substr(3,2), 16), parseInt(v.substr(5,2), 16)];
      }

      function hueInputToByte(e) {
        const h = document.getElementById(e).value;
        return Math.floor(255 * (h / 330.0));
      }

      function showTab(s) {
        contents[selectedIndex].style.display = 'none';
        contents[s].style.display = 'flex';

        links[selectedIndex].classList.remove('tab-link-selected');
        links[s].classList.add('tab-link-selected');

        selectedIndex = s;
      }

      function submit() {
        if(selectedIndex == 3) {
          const secondsPerDay = 24 * 60 * 60;
          const dateNow = new Date();
          const dateTarget = new Date(dateNow.toISOString().split('T')[0] + 'T' + document.getElementById('sunrise-time').value);
          let secondsTillAlarm = Math.floor((dateTarget.getTime() - dateNow.getTime()) / 1000);
          if(secondsTillAlarm < 0) {
            secondsTillAlarm += secondsPerDay;
          } else {
            // Since dateTarget uses UTC time in calculation, it could be a into the next day. Correct for that: 
            secondsTillAlarm %= secondsPerDay;
          }

          console.log("seconds till:", secondsTillAlarm);
          postData([2, 
            (secondsTillAlarm >>> 16) & 0xff, (secondsTillAlarm >>> 8) & 0xff, (secondsTillAlarm >>> 0) & 0xff]
            .concat(inputToRGB('sunrise-color'))
            .concat(document.getElementById('sunrise-duration').value));
        } else if(selectedIndex == 1) {
          postData([3, 
            hueInputToByte('swirl-hue-1'), hueInputToByte('swirl-hue-2'), hueInputToByte('swirl-hue-3'),
            document.getElementById('swirl-speed').value, document.getElementById('swirl-brightness').value]);
        } else if(selectedIndex == 0) {
          postData([4, 
            1 ? document.getElementById('rave-value-rainbow').checked : 0, 
            document.getElementById('rave-speed').value, document.getElementById('rave-brightness').value]);
        } else if(selectedIndex == 2) {
          postData([1]
            .concat(inputToRGB('solid-color')));
        }
      }

      function postData(d) {
        const data = new Uint8Array(d);
        console.log("posting data:", data);
        // const url = window.location.href;
        const url = 'http://192.168.4.44';
        fetch(url, {method: 'POST', body: data});
      }

      window.onload = () => {
        contents = document.getElementsByClassName('tab-content');
        links = document.getElementsByClassName('tab-link');

        const swirlHue1 = document.getElementById('swirl-hue-1');
        swirlHue1.addEventListener('input', () => document.getElementById('swirl-hue-1-parent').style.backgroundColor = `hsl(${swirlHue1.value}, 100%, 50%)`);
        const swirlHue2 = document.getElementById('swirl-hue-2');
        swirlHue2.addEventListener('input', () => document.getElementById('swirl-hue-2-parent').style.backgroundColor = `hsl(${swirlHue2.value}, 100%, 50%)`);
        const swirlHue3 = document.getElementById('swirl-hue-3');
        swirlHue3.addEventListener('input', () => document.getElementById('swirl-hue-3-parent').style.backgroundColor = `hsl(${swirlHue3.value}, 100%, 50%)`);

        selectedIndex = 0;
        showTab(1);
      }
    </script>
  </body>
</html>